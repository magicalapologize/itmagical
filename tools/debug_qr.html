<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>二维码调试测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        canvas {
            border: 1px solid #ccc;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>二维码生成调试测试</h1>
    
    <div class="test-section">
        <h2>库状态检查</h2>
        <div id="libraryStatus" class="status"></div>
        <button onclick="checkLibraryStatus()">检查库状态</button>
    </div>
    
    <div class="test-section">
        <h2>简单测试</h2>
        <input type="text" id="testText" value="Hello World" placeholder="输入测试文本">
        <br>
        <button onclick="simpleTest()">生成测试二维码</button>
        <div id="simpleResult"></div>
    </div>
    
    <div class="test-section">
        <h2>完整测试</h2>
        <input type="text" id="fullTestText" value="https://www.example.com" placeholder="输入测试内容">
        <br>
        <label>尺寸: <input type="number" id="testSize" value="200" min="100" max="500"></label>
        <label>容错级别: 
            <select id="testErrorLevel">
                <option value="L">低 (7%)</option>
                <option value="M" selected>中 (15%)</option>
                <option value="Q">高 (25%)</option>
                <option value="H">最高 (30%)</option>
            </select>
        </label>
        <br>
        <button onclick="fullTest()">完整测试</button>
        <div id="fullResult"></div>
    </div>
    
    <div class="test-section">
        <h2>错误日志</h2>
        <div id="errorLog"></div>
        <button onclick="clearLog()">清空日志</button>
    </div>

    <script>
        // 简化的QRCode生成器类
        class QRCodeGenerator {
            constructor() {
                this.modules = [];
                this.moduleCount = 0;
            }
            
            make(text, options = {}) {
                try {
                    const errorLevel = options.correctLevel || options.errorCorrectionLevel || 'M';
                    const typeNumber = this.getTypeNumber(text, errorLevel);
                    
                    this.moduleCount = typeNumber * 4 + 17;
                    this.modules = Array(this.moduleCount).fill().map(() => Array(this.moduleCount).fill(false));
                    
                    this.setupPositionProbePattern(0, 0);
                    this.setupPositionProbePattern(this.moduleCount - 7, 0);
                    this.setupPositionProbePattern(0, this.moduleCount - 7);
                    
                    this.setupTimingPattern();
                    
                    const data = this.createData(text, errorLevel);
                    this.mapData(data, this.getMask());
                    
                    return true;
                } catch (error) {
                    logError('QRCode生成错误: ' + error.message);
                    throw error;
                }
            }
            
            getTypeNumber(text, errorLevel) {
                const length = text.length;
                if (length <= 25) return 1;
                if (length <= 47) return 2;
                if (length <= 77) return 3;
                if (length <= 114) return 4;
                return 5;
            }
            
            setupPositionProbePattern(row, col) {
                for (let r = -1; r <= 7; r++) {
                    for (let c = -1; c <= 7; c++) {
                        if (row + r >= 0 && this.moduleCount > row + r && col + c >= 0 && this.moduleCount > col + c) {
                            if ((0 <= r && r <= 6 && (c == 0 || c == 6)) ||
                                (0 <= c && c <= 6 && (r == 0 || r == 6)) ||
                                (2 <= r && r <= 4 && 2 <= c && c <= 4)) {
                                this.modules[row + r][col + c] = true;
                            } else {
                                this.modules[row + r][col + c] = false;
                            }
                        }
                    }
                }
            }
            
            setupTimingPattern() {
                for (let r = 8; r < this.moduleCount - 8; r++) {
                    if (this.modules[r][6] == null) {
                        this.modules[r][6] = (r % 2 == 0);
                    }
                }
                for (let c = 8; c < this.moduleCount - 8; c++) {
                    if (this.modules[6][c] == null) {
                        this.modules[6][c] = (c % 2 == 0);
                    }
                }
            }
            
            createData(text, errorLevel) {
                // 简化的数据创建
                const data = [];
                for (let i = 0; i < text.length; i++) {
                    data.push(text.charCodeAt(i));
                }
                return data;
            }
            
            mapData(data, mask) {
                // 简化的数据映射
                let inc = -1;
                let row = this.moduleCount - 1;
                let bitIndex = 7;
                let byteIndex = 0;
                
                for (let col = this.moduleCount - 1; col > 0; col -= 2) {
                    if (col == 6) col--;
                    
                    while (true) {
                        for (let c = 0; c < 2; c++) {
                            if (this.modules[row][col - c] == null) {
                                let dark = false;
                                if (byteIndex < data.length) {
                                    dark = (((data[byteIndex] >>> bitIndex) & 1) == 1);
                                }
                                this.modules[row][col - c] = dark;
                                bitIndex--;
                                if (bitIndex == -1) {
                                    byteIndex++;
                                    bitIndex = 7;
                                }
                            }
                        }
                        row += inc;
                        if (row < 0 || this.moduleCount <= row) {
                            row -= inc;
                            inc = -inc;
                            break;
                        }
                    }
                }
            }
            
            getMask() {
                return 0; // 简化的掩码
            }
            
            isDark(row, col) {
                if (row < 0 || this.moduleCount <= row || col < 0 || this.moduleCount <= col) {
                    return false;
                }
                return this.modules[row][col];
            }
            
            getModuleCount() {
                return this.moduleCount;
            }
        }
        
        // 创建全局QRCode对象
        window.QRCode = {
            toCanvas: function(canvas, text, options, callback) {
                if (typeof options === 'function') {
                    callback = options;
                    options = {};
                }
                
                try {
                    const qr = new QRCodeGenerator();
                    qr.make(text, options);
                    
                    const size = options.width || options.height || 200;
                    canvas.width = size;
                    canvas.height = size;
                    
                    const ctx = canvas.getContext('2d');
                    const moduleCount = qr.getModuleCount();
                    const cellSize = size / moduleCount;
                    
                    ctx.fillStyle = options.color?.light || '#ffffff';
                    ctx.fillRect(0, 0, size, size);
                    
                    ctx.fillStyle = options.color?.dark || '#000000';
                    
                    for (let row = 0; row < moduleCount; row++) {
                        for (let col = 0; col < moduleCount; col++) {
                            if (qr.isDark(row, col)) {
                                ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                            }
                        }
                    }
                    
                    if (callback) callback(null);
                } catch (error) {
                    logError('Canvas生成错误: ' + error.message);
                    if (callback) callback(error);
                    else throw error;
                }
            }
        };
        
        // 日志函数
        function logError(message) {
            console.error(message);
            const errorLog = document.getElementById('errorLog');
            const timestamp = new Date().toLocaleTimeString();
            errorLog.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        }
        
        function logInfo(message) {
            console.log(message);
            const errorLog = document.getElementById('errorLog');
            const timestamp = new Date().toLocaleTimeString();
            errorLog.innerHTML += `<div style="color: blue;">[${timestamp}] ${message}</div>`;
        }
        
        // 检查库状态
        function checkLibraryStatus() {
            const statusDiv = document.getElementById('libraryStatus');
            
            if (typeof QRCode !== 'undefined') {
                statusDiv.className = 'status success';
                statusDiv.textContent = '✅ QRCode库已加载并可用';
                logInfo('QRCode库状态检查通过');
            } else {
                statusDiv.className = 'status error';
                statusDiv.textContent = '❌ QRCode库未找到';
                logError('QRCode库未找到');
            }
        }
        
        // 简单测试
        function simpleTest() {
            const text = document.getElementById('testText').value;
            const resultDiv = document.getElementById('simpleResult');
            
            if (!text) {
                resultDiv.innerHTML = '<div class="status error">请输入测试文本</div>';
                return;
            }
            
            try {
                const canvas = document.createElement('canvas');
                
                QRCode.toCanvas(canvas, text, { width: 150, height: 150 }, function(error) {
                    if (error) {
                        resultDiv.innerHTML = `<div class="status error">生成失败: ${error.message}</div>`;
                        logError('简单测试失败: ' + error.message);
                    } else {
                        resultDiv.innerHTML = '<div class="status success">✅ 生成成功</div>';
                        resultDiv.appendChild(canvas);
                        logInfo('简单测试成功');
                    }
                });
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">生成失败: ${error.message}</div>`;
                logError('简单测试异常: ' + error.message);
            }
        }
        
        // 完整测试
        function fullTest() {
            const text = document.getElementById('fullTestText').value;
            const size = parseInt(document.getElementById('testSize').value);
            const errorLevel = document.getElementById('testErrorLevel').value;
            const resultDiv = document.getElementById('fullResult');
            
            if (!text) {
                resultDiv.innerHTML = '<div class="status error">请输入测试内容</div>';
                return;
            }
            
            try {
                const canvas = document.createElement('canvas');
                
                const options = {
                    width: size,
                    height: size,
                    errorCorrectionLevel: errorLevel,
                    color: {
                        dark: '#000000',
                        light: '#ffffff'
                    }
                };
                
                QRCode.toCanvas(canvas, text, options, function(error) {
                    if (error) {
                        resultDiv.innerHTML = `<div class="status error">生成失败: ${error.message}</div>`;
                        logError('完整测试失败: ' + error.message);
                    } else {
                        resultDiv.innerHTML = `<div class="status success">✅ 生成成功 (${size}x${size}, 容错级别: ${errorLevel})</div>`;
                        resultDiv.appendChild(canvas);
                        logInfo(`完整测试成功: ${text.substring(0, 50)}${text.length > 50 ? '...' : ''}`);
                    }
                });
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">生成失败: ${error.message}</div>`;
                logError('完整测试异常: ' + error.message);
            }
        }
        
        // 清空日志
        function clearLog() {
            document.getElementById('errorLog').innerHTML = '';
        }
        
        // 页面加载完成后自动检查
        document.addEventListener('DOMContentLoaded', function() {
            checkLibraryStatus();
            logInfo('调试页面加载完成');
        });
    </script>
</body>
</html>