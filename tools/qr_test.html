<!DOCTYPE html>
<html>
<head>
    <title>QR Code Test</title>
</head>
<body>
    <h1>QR Code Test</h1>
    <canvas id="qrCanvas" width="300" height="300" style="border: 1px solid #ccc;"></canvas>
    <br><br>
    <button onclick="testQR()">Generate Test QR</button>
    <div id="result"></div>
    
    <script>
        // 复制QRCodeGenerator类
        class QRCodeGenerator {
            constructor() {
                this.modules = [];
                this.moduleCount = 0;
                this.errorCorrectLevel = { L: 1, M: 0, Q: 3, H: 2 };
            }
            
            make(text, options = {}) {
                try {
                    const typeNumber = options.typeNumber || this.getTypeNumber(text);
                    const errorCorrectLevel = this.errorCorrectLevel[options.correctLevel || 'M'];
                    
                    console.log('Making QR with:', { text, typeNumber, errorCorrectLevel });
                    
                    this.moduleCount = typeNumber * 4 + 17;
                    this.modules = new Array(this.moduleCount);
                    
                    for (let row = 0; row < this.moduleCount; row++) {
                        this.modules[row] = new Array(this.moduleCount);
                        for (let col = 0; col < this.moduleCount; col++) {
                            this.modules[row][col] = null;
                        }
                    }
                    
                    this.setupPositionProbePattern(0, 0);
                    this.setupPositionProbePattern(this.moduleCount - 7, 0);
                    this.setupPositionProbePattern(0, this.moduleCount - 7);
                    this.setupPositionAdjustPattern();
                    this.setupTimingPattern();
                    this.setupTypeInfo(errorCorrectLevel, 0);
                    
                    if (typeNumber >= 7) {
                        this.setupTypeNumber(typeNumber);
                    }
                    
                    const data = this.createData(typeNumber, errorCorrectLevel, text);
                    this.mapData(data, 0);
                    
                    console.log('QR generation completed successfully');
                    return this;
                } catch (error) {
                    console.error('QR generation error:', error);
                    throw error;
                }
            }
            
            getTypeNumber(text) {
                const length = text.length;
                if (length <= 14) return 1;
                if (length <= 26) return 2;
                if (length <= 42) return 3;
                if (length <= 62) return 4;
                if (length <= 84) return 5;
                if (length <= 106) return 6;
                if (length <= 122) return 7;
                if (length <= 152) return 8;
                if (length <= 180) return 9;
                return 10;
            }
            
            isDark(row, col) {
                if (row < 0 || this.moduleCount <= row || col < 0 || this.moduleCount <= col) {
                    return false;
                }
                return this.modules[row][col];
            }
            
            getModuleCount() {
                return this.moduleCount;
            }
            
            // 简化的实现，只包含基本功能
            setupPositionProbePattern(row, col) {
                for (let r = -1; r <= 7; r++) {
                    if (row + r <= -1 || this.moduleCount <= row + r) continue;
                    for (let c = -1; c <= 7; c++) {
                        if (col + c <= -1 || this.moduleCount <= col + c) continue;
                        if ((0 <= r && r <= 6 && (c == 0 || c == 6)) ||
                            (0 <= c && c <= 6 && (r == 0 || r == 6)) ||
                            (2 <= r && r <= 4 && 2 <= c && c <= 4)) {
                            this.modules[row + r][col + c] = true;
                        } else {
                            this.modules[row + r][col + c] = false;
                        }
                    }
                }
            }
            
            setupPositionAdjustPattern() {
                // 简化实现
            }
            
            setupTimingPattern() {
                for (let r = 8; r < this.moduleCount - 8; r++) {
                    if (this.modules[r][6] != null) continue;
                    this.modules[r][6] = (r % 2 == 0);
                }
                for (let c = 8; c < this.moduleCount - 8; c++) {
                    if (this.modules[6][c] != null) continue;
                    this.modules[6][c] = (c % 2 == 0);
                }
            }
            
            setupTypeInfo(errorCorrectLevel, maskPattern) {
                // 简化实现
                for (let i = 0; i < 15; i++) {
                    this.modules[i < 6 ? i : i + 1][8] = (i % 2 == 0);
                    this.modules[8][i < 8 ? this.moduleCount - i - 1 : 15 - i - 1] = (i % 2 == 0);
                }
                this.modules[this.moduleCount - 8][8] = true;
            }
            
            setupTypeNumber(typeNumber) {
                // 简化实现
            }
            
            createData(typeNumber, errorCorrectLevel, text) {
                // 返回简单的测试数据
                const data = [];
                for (let i = 0; i < 100; i++) {
                    data.push(Math.random() > 0.5 ? 1 : 0);
                }
                return data;
            }
            
            mapData(data, maskPattern) {
                // 简化的数据映射
                let dataIndex = 0;
                for (let row = 0; row < this.moduleCount; row++) {
                    for (let col = 0; col < this.moduleCount; col++) {
                        if (this.modules[row][col] == null && dataIndex < data.length) {
                            this.modules[row][col] = data[dataIndex] == 1;
                            dataIndex++;
                        }
                    }
                }
            }
        }
        
        function testQR() {
            try {
                const canvas = document.getElementById('qrCanvas');
                const ctx = canvas.getContext('2d');
                
                // 清空画布
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // 生成QR码
                const qr = new QRCodeGenerator();
                qr.make('Hello World', { correctLevel: 'M' });
                
                // 绘制QR码
                const moduleCount = qr.getModuleCount();
                const cellSize = Math.floor(canvas.width / moduleCount);
                
                ctx.fillStyle = '#000000';
                for (let row = 0; row < moduleCount; row++) {
                    for (let col = 0; col < moduleCount; col++) {
                        if (qr.isDark(row, col)) {
                            ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                        }
                    }
                }
                
                document.getElementById('result').innerHTML = '<p style="color: green;">QR Code generated successfully!</p>';
            } catch (error) {
                console.error('Test failed:', error);
                document.getElementById('result').innerHTML = '<p style="color: red;">Test failed: ' + error.message + '</p>';
            }
        }
    </script>
</body>
</html>