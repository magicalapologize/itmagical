<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片水印工具 - 在线添加图片水印 | ITMagical</title>
    <meta name="description" content="专业的在线图片水印工具，支持文字水印和图片水印批量添加，多种样式自定义，保护您的图片版权，完全免费使用。">
    <meta name="keywords" content="图片水印,在线水印,批量水印,文字水印,图片水印,版权保护,水印添加,免费水印工具">
    <meta name="author" content="ITMagical">
    <meta property="og:title" content="图片水印工具 - 在线添加图片水印">
    <meta property="og:description" content="专业的在线图片水印工具，支持文字水印和图片水印批量添加">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tool.itmagical.top/tools/图片水印工具.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="图片水印工具 - 在线添加图片水印">
    <meta name="twitter:description" content="专业的在线图片水印工具，支持文字水印和图片水印批量添加">
    <link rel="canonical" href="https://tool.itmagical.top/tools/图片水印工具.html">
    <link rel="icon" type="image/x-icon" href="../../assets/favicon.ico">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .tool-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background-color: #f8f9ff;
        }
        
        .upload-area.dragover {
            border-color: #764ba2;
            background-color: #f0f2ff;
        }
        
        .upload-icon {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .watermark-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        
        .control-group h3 {
            margin-bottom: 15px;
            color: #667eea;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .color-input {
            width: 50px !important;
            height: 40px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .range-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .range-group input[type="range"] {
            flex: 1;
        }
        
        .range-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .preview-area {
            margin-top: 20px;
            text-align: center;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .file-list {
            margin-top: 20px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-thumbnail {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .guide-section,
        .intro-section,
        .promo-section,
        .features-section,
        .faq-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .section-title {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .guide-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .step {
            text-align: center;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
        }
        
        .step-number {
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-weight: bold;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .feature-card {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .feature-icon {
            font-size: 2.5em;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .faq-item {
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .faq-question {
            background: #f8f9fa;
            padding: 15px 20px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .faq-question:hover {
            background: #e9ecef;
        }
        
        .faq-answer {
            padding: 15px 20px;
            display: none;
            background: white;
        }
        
        .faq-answer.active {
            display: block;
        }
        
        .footer-info {
            text-align: center;
            color: white;
            margin-top: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }
        
        @media (max-width: 768px) {
            .watermark-controls {
                grid-template-columns: 1fr;
            }
            
            .guide-steps {
                grid-template-columns: 1fr;
            }
            
            .features-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div id="navbar-placeholder"></div>
    
    <div class="container">
        <div class="header">
            <h1>🖼️ 图片水印工具</h1>
            <p>专业的在线图片水印添加工具，支持文字和图片水印批量处理，保护您的图片版权</p>
        </div>
        
        <div class="tool-container">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">📁</div>
                <h3>拖拽图片到此处或点击选择文件</h3>
                <p>支持 JPG、PNG、WEBP、BMP 等格式，支持批量上传</p>
                <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
            </div>
            
            <div class="watermark-controls">
                <div class="control-group">
                    <h3>📝 文字水印设置</h3>
                    <div class="form-group">
                        <label>水印文字</label>
                        <textarea id="watermarkText" placeholder="输入水印文字内容" rows="2">© ITMagical</textarea>
                    </div>
                    <div class="form-group">
                        <label>字体大小</label>
                        <div class="range-group">
                            <input type="range" id="fontSize" min="12" max="100" value="24">
                            <span class="range-value" id="fontSizeValue">24px</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>字体颜色</label>
                        <input type="color" id="fontColor" value="#ffffff" class="color-input">
                    </div>
                    <div class="form-group">
                        <label>字体样式</label>
                        <select id="fontFamily">
                            <option value="Arial">Arial</option>
                            <option value="Microsoft YaHei">微软雅黑</option>
                            <option value="SimHei">黑体</option>
                            <option value="SimSun">宋体</option>
                            <option value="Times New Roman">Times New Roman</option>
                        </select>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>🎨 水印样式设置</h3>
                    <div class="form-group">
                        <label>水印位置</label>
                        <select id="watermarkPosition">
                            <option value="bottom-right">右下角</option>
                            <option value="bottom-left">左下角</option>
                            <option value="top-right">右上角</option>
                            <option value="top-left">左上角</option>
                            <option value="center">居中</option>
                            <option value="repeat">平铺</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>透明度</label>
                        <div class="range-group">
                            <input type="range" id="opacity" min="0.1" max="1" step="0.1" value="0.7">
                            <span class="range-value" id="opacityValue">70%</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>旋转角度</label>
                        <div class="range-group">
                            <input type="range" id="rotation" min="-45" max="45" value="0">
                            <span class="range-value" id="rotationValue">0°</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>边距</label>
                        <div class="range-group">
                            <input type="range" id="margin" min="10" max="100" value="20">
                            <span class="range-value" id="marginValue">20px</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>🖼️ 图片水印（可选）</label>
                <input type="file" id="watermarkImage" accept="image/*">
                <small>选择图片作为水印，将覆盖文字水印设置</small>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn" id="addWatermarkBtn">🎨 添加水印</button>
                <button class="btn btn-secondary" id="previewBtn">👁️ 预览效果</button>
                <button class="btn btn-success" id="downloadAllBtn" style="display: none;">📥 下载全部</button>
                <button class="btn btn-secondary" id="resetBtn">🔄 重置</button>
            </div>
            
            <div class="preview-area" id="previewArea" style="display: none;">
                <h3>预览效果</h3>
                <canvas id="previewCanvas" style="max-width: 100%; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);"></canvas>
            </div>
            
            <div class="file-list" id="fileList"></div>
        </div>
        
        <div class="guide-section">
            <h2 class="section-title">📖 使用指南</h2>
            <div class="guide-steps">
                <div class="step">
                    <div class="step-number">1</div>
                    <h3>上传图片</h3>
                    <p>拖拽或点击选择需要添加水印的图片文件，支持批量上传多张图片</p>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <h3>设置水印</h3>
                    <p>输入水印文字或上传水印图片，调整字体、颜色、位置、透明度等参数</p>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <h3>预览效果</h3>
                    <p>点击预览按钮查看水印效果，可随时调整参数直到满意</p>
                </div>
                <div class="step">
                    <div class="step-number">4</div>
                    <h3>下载结果</h3>
                    <p>确认效果后点击添加水印，系统将自动处理并提供下载链接</p>
                </div>
            </div>
        </div>
        
        <div class="intro-section">
            <h2 class="section-title">🎯 工具详细介绍</h2>
            <p>ITMagical图片水印工具是一款专业的在线图片版权保护工具，采用先进的Canvas技术实现高质量水印添加。无论您是摄影师、设计师还是内容创作者，都可以通过我们的工具快速为图片添加个性化水印，有效保护您的知识产权。</p>
            
            <h3>🔧 核心技术特性</h3>
            <ul>
                <li><strong>高质量渲染：</strong>基于HTML5 Canvas技术，确保水印添加后图片质量不损失</li>
                <li><strong>批量处理：</strong>支持同时处理多张图片，大幅提升工作效率</li>
                <li><strong>实时预览：</strong>所见即所得的预览功能，让您精确控制水印效果</li>
                <li><strong>多种格式：</strong>支持JPG、PNG、WEBP、BMP等主流图片格式</li>
                <li><strong>隐私保护：</strong>所有处理均在浏览器本地完成，图片不会上传到服务器</li>
            </ul>
            
            <h3>🎨 水印定制选项</h3>
            <ul>
                <li><strong>文字水印：</strong>自定义文字内容、字体、大小、颜色和样式</li>
                <li><strong>图片水印：</strong>上传Logo或签名图片作为水印</li>
                <li><strong>位置控制：</strong>9种预设位置加平铺模式，满足不同需求</li>
                <li><strong>透明度调节：</strong>精确控制水印透明度，平衡保护效果和美观度</li>
                <li><strong>旋转角度：</strong>支持-45°到45°的角度调整</li>
            </ul>
        </div>
        
        <div class="promo-section">
            <h2 class="section-title">🌟 为什么选择我们的图片水印工具？</h2>
            <p>在数字化时代，图片版权保护变得越来越重要。我们的图片水印工具不仅功能强大，更注重用户体验和隐私保护。与其他同类工具相比，我们具有以下独特优势：</p>
            
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">🚀</div>
                    <h3>极速处理</h3>
                    <p>本地处理技术，无需等待上传下载，秒级完成水印添加</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">🔒</div>
                    <h3>隐私安全</h3>
                    <p>图片不离开您的设备，100%保护您的隐私和数据安全</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">🎨</div>
                    <h3>专业品质</h3>
                    <p>高质量渲染引擎，确保水印效果专业美观</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">💰</div>
                    <h3>完全免费</h3>
                    <p>无需注册，无使用限制，永久免费使用所有功能</p>
                </div>
            </div>
        </div>
        
        <div class="features-section">
            <h2 class="section-title">⭐ 工具优势与核心功能</h2>
            
            <h3>🏆 核心优势</h3>
            <ul>
                <li><strong>专业级水印效果：</strong>支持文字和图片水印，多种混合模式</li>
                <li><strong>批量处理能力：</strong>一次性处理数百张图片，节省大量时间</li>
                <li><strong>精确参数控制：</strong>像素级精度的位置、大小、透明度控制</li>
                <li><strong>跨平台兼容：</strong>支持Windows、Mac、Linux、iOS、Android等所有平台</li>
                <li><strong>无损质量保证：</strong>先进的图像处理算法，确保原图质量</li>
            </ul>
            
            <h3>🎯 应用场景</h3>
            <ul>
                <li><strong>摄影师：</strong>为作品添加署名水印，保护版权</li>
                <li><strong>设计师：</strong>为设计稿添加工作室Logo</li>
                <li><strong>电商卖家：</strong>为商品图片添加店铺水印</li>
                <li><strong>自媒体：</strong>为原创图片添加品牌标识</li>
                <li><strong>企业用户：</strong>为宣传图片添加公司Logo</li>
                <li><strong>个人用户：</strong>为社交媒体图片添加个性签名</li>
            </ul>
            
            <h3>🔧 技术特性</h3>
            <ul>
                <li><strong>HTML5 Canvas：</strong>现代浏览器原生支持，性能卓越</li>
                <li><strong>响应式设计：</strong>完美适配桌面端、平板和手机</li>
                <li><strong>拖拽上传：</strong>直观的文件拖拽操作体验</li>
                <li><strong>实时预览：</strong>参数调整即时反馈，所见即所得</li>
                <li><strong>格式兼容：</strong>支持主流图片格式的输入和输出</li>
            </ul>
        </div>
        
        <div class="faq-section">
            <h2 class="section-title">❓ 常见问题解答</h2>
            
            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span>支持哪些图片格式？</span>
                    <span>+</span>
                </div>
                <div class="faq-answer">
                    <p>我们支持所有主流图片格式，包括JPG、JPEG、PNG、WEBP、BMP、GIF等。输出格式默认为PNG（支持透明度）和JPG（文件更小）。</p>
                </div>
            </div>
            
            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span>可以同时处理多少张图片？</span>
                    <span>+</span>
                </div>
                <div class="faq-answer">
                    <p>理论上没有数量限制，但受限于浏览器内存。建议单次处理不超过100张图片，每张图片不超过10MB，以确保最佳性能。</p>
                </div>
            </div>
            
            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span>图片会被上传到服务器吗？</span>
                    <span>+</span>
                </div>
                <div class="faq-answer">
                    <p>不会。所有图片处理都在您的浏览器本地完成，图片文件不会离开您的设备，完全保护您的隐私和数据安全。</p>
                </div>
            </div>
            
            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span>水印会影响图片质量吗？</span>
                    <span>+</span>
                </div>
                <div class="faq-answer">
                    <p>我们使用高质量的Canvas渲染技术，在添加水印的同时最大程度保持原图质量。您可以选择PNG格式输出以获得最佳质量。</p>
                </div>
            </div>
            
            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span>如何制作透明背景的图片水印？</span>
                    <span>+</span>
                </div>
                <div class="faq-answer">
                    <p>上传PNG格式的水印图片即可保持透明背景。建议使用专业设计软件制作带透明背景的Logo或签名。</p>
                </div>
            </div>
            
            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span>可以保存水印设置吗？</span>
                    <span>+</span>
                </div>
                <div class="faq-answer">
                    <p>当前版本暂不支持保存设置，但您的设置在当前会话中会被保持。我们正在开发设置保存功能，敬请期待。</p>
                </div>
            </div>
            
            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span>移动设备上可以使用吗？</span>
                    <span>+</span>
                </div>
                <div class="faq-answer">
                    <p>完全可以！我们的工具采用响应式设计，在手机和平板上都能完美运行，操作体验与桌面版一致。</p>
                </div>
            </div>
        </div>
        
        <div class="footer-info">
            <p>@2025 专业的在线图片水印工具，保护您的图片版权，完全免费使用</p>
        </div>
    </div>
    
    <div id="footer-placeholder"></div>
    
    <script>
        // 全局变量
        let uploadedFiles = [];
        let watermarkImageFile = null;
        let processedImages = [];
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            updateRangeValues();
            loadComponents();
        });
        
        // 初始化事件监听器
        function initializeEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const watermarkImageInput = document.getElementById('watermarkImage');
            
            // 文件上传事件
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
            watermarkImageInput.addEventListener('change', handleWatermarkImageSelect);
            
            // 按钮事件
            document.getElementById('addWatermarkBtn').addEventListener('click', addWatermarkToAll);
            document.getElementById('previewBtn').addEventListener('click', previewWatermark);
            document.getElementById('downloadAllBtn').addEventListener('click', downloadAll);
            document.getElementById('resetBtn').addEventListener('click', resetAll);
            
            // 范围滑块事件
            document.getElementById('fontSize').addEventListener('input', updateRangeValues);
            document.getElementById('opacity').addEventListener('input', updateRangeValues);
            document.getElementById('rotation').addEventListener('input', updateRangeValues);
            document.getElementById('margin').addEventListener('input', updateRangeValues);
        }
        
        // 拖拽处理
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            if (files.length > 0) {
                addFiles(files);
            }
        }
        
        // 文件选择处理
        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            addFiles(files);
        }
        
        // 水印图片选择
        function handleWatermarkImageSelect(e) {
            const file = e.target.files[0];
            if (file) {
                watermarkImageFile = file;
                showNotification('水印图片已选择：' + file.name);
            }
        }
        
        // 添加文件
        function addFiles(files) {
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    uploadedFiles.push({
                        file: file,
                        id: Date.now() + Math.random(),
                        processed: false
                    });
                }
            });
            updateFileList();
            showNotification(`已添加 ${files.length} 个文件`);
        }
        
        // 更新文件列表
        function updateFileList() {
            const fileList = document.getElementById('fileList');
            if (uploadedFiles.length === 0) {
                fileList.innerHTML = '';
                return;
            }
            
            fileList.innerHTML = '<h3>📁 已上传的文件</h3>';
            
            uploadedFiles.forEach((fileData, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <img class="file-thumbnail" src="" alt="缩略图" id="thumb-${fileData.id}">
                        <div>
                            <div><strong>${fileData.file.name}</strong></div>
                            <div style="color: #666; font-size: 12px;">${formatFileSize(fileData.file.size)}</div>
                        </div>
                    </div>
                    <div>
                        ${fileData.processed ? '<span style="color: green;">✅ 已处理</span>' : '<span style="color: #666;">⏳ 待处理</span>'}
                        <button class="btn btn-secondary" onclick="removeFile(${index})" style="margin-left: 10px; padding: 5px 10px;">删除</button>
                    </div>
                    <div class="progress-bar" id="progress-${fileData.id}" style="display: none;">
                        <div class="progress-fill"></div>
                    </div>
                `;
                fileList.appendChild(fileItem);
                
                // 生成缩略图
                generateThumbnail(fileData.file, `thumb-${fileData.id}`);
            });
        }
        
        // 生成缩略图
        function generateThumbnail(file, imgId) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById(imgId);
                if (img) {
                    img.src = e.target.result;
                }
            };
            reader.readAsDataURL(file);
        }
        
        // 删除文件
        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileList();
        }
        
        // 更新范围值显示
        function updateRangeValues() {
            const fontSize = document.getElementById('fontSize');
            const opacity = document.getElementById('opacity');
            const rotation = document.getElementById('rotation');
            const margin = document.getElementById('margin');
            
            document.getElementById('fontSizeValue').textContent = fontSize.value + 'px';
            document.getElementById('opacityValue').textContent = Math.round(opacity.value * 100) + '%';
            document.getElementById('rotationValue').textContent = rotation.value + '°';
            document.getElementById('marginValue').textContent = margin.value + 'px';
        }
        
        // 预览水印效果
        function previewWatermark() {
            if (uploadedFiles.length === 0) {
                showNotification('请先上传图片文件', 'error');
                return;
            }
            
            const firstFile = uploadedFiles[0].file;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.getElementById('previewCanvas');
                    const ctx = canvas.getContext('2d');
                    
                    // 设置画布尺寸
                    const maxWidth = 800;
                    const maxHeight = 600;
                    let { width, height } = calculateDimensions(img.width, img.height, maxWidth, maxHeight);
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // 绘制图片
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // 添加水印
                    addWatermarkToCanvas(ctx, width, height);
                    
                    // 显示预览
                    document.getElementById('previewArea').style.display = 'block';
                    canvas.scrollIntoView({ behavior: 'smooth' });
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(firstFile);
        }
        
        // 为所有图片添加水印
        async function addWatermarkToAll() {
            if (uploadedFiles.length === 0) {
                showNotification('请先上传图片文件', 'error');
                return;
            }
            
            const watermarkText = document.getElementById('watermarkText').value.trim();
            if (!watermarkText && !watermarkImageFile) {
                showNotification('请输入水印文字或选择水印图片', 'error');
                return;
            }
            
            processedImages = [];
            const addBtn = document.getElementById('addWatermarkBtn');
            addBtn.disabled = true;
            addBtn.textContent = '处理中...';
            
            for (let i = 0; i < uploadedFiles.length; i++) {
                const fileData = uploadedFiles[i];
                const progressBar = document.getElementById(`progress-${fileData.id}`);
                progressBar.style.display = 'block';
                
                try {
                    const processedBlob = await processImage(fileData.file, (progress) => {
                        const fill = progressBar.querySelector('.progress-fill');
                        fill.style.width = progress + '%';
                    });
                    
                    processedImages.push({
                        blob: processedBlob,
                        name: fileData.file.name.replace(/\.[^/.]+$/, '') + '_watermark.png'
                    });
                    
                    fileData.processed = true;
                    
                } catch (error) {
                    console.error('处理图片失败:', error);
                    showNotification(`处理 ${fileData.file.name} 失败`, 'error');
                }
            }
            
            addBtn.disabled = false;
            addBtn.textContent = '🎨 添加水印';
            updateFileList();
            
            if (processedImages.length > 0) {
                document.getElementById('downloadAllBtn').style.display = 'inline-block';
                showNotification(`成功处理 ${processedImages.length} 张图片`);
            }
        }
        
        // 处理单张图片
        function processImage(file, progressCallback) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        try {
                            progressCallback(30);
                            
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            canvas.width = img.width;
                            canvas.height = img.height;
                            
                            // 绘制原图
                            ctx.drawImage(img, 0, 0);
                            progressCallback(60);
                            
                            // 添加水印
                            addWatermarkToCanvas(ctx, img.width, img.height);
                            progressCallback(90);
                            
                            // 转换为Blob
                            canvas.toBlob((blob) => {
                                progressCallback(100);
                                resolve(blob);
                            }, 'image/png', 0.9);
                            
                        } catch (error) {
                            reject(error);
                        }
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // 在画布上添加水印
        async function addWatermarkToCanvas(ctx, width, height) {
            const position = document.getElementById('watermarkPosition').value;
            const opacity = parseFloat(document.getElementById('opacity').value);
            const rotation = parseInt(document.getElementById('rotation').value);
            const margin = parseInt(document.getElementById('margin').value);
            
            ctx.globalAlpha = opacity;
            
            if (watermarkImageFile) {
                // 图片水印
                await addImageWatermark(ctx, width, height, position, rotation, margin);
            } else {
                // 文字水印
                addTextWatermark(ctx, width, height, position, rotation, margin);
            }
            
            ctx.globalAlpha = 1;
        }
        
        // 添加文字水印
        function addTextWatermark(ctx, width, height, position, rotation, margin) {
            const text = document.getElementById('watermarkText').value;
            const fontSize = parseInt(document.getElementById('fontSize').value);
            const fontColor = document.getElementById('fontColor').value;
            const fontFamily = document.getElementById('fontFamily').value;
            
            ctx.font = `${fontSize}px ${fontFamily}`;
            ctx.fillStyle = fontColor;
            ctx.textBaseline = 'top';
            
            const textMetrics = ctx.measureText(text);
            const textWidth = textMetrics.width;
            const textHeight = fontSize;
            
            if (position === 'repeat') {
                // 平铺水印
                const spacing = Math.max(textWidth, textHeight) + 50;
                for (let x = 0; x < width; x += spacing) {
                    for (let y = 0; y < height; y += spacing) {
                        ctx.save();
                        ctx.translate(x + textWidth/2, y + textHeight/2);
                        ctx.rotate(rotation * Math.PI / 180);
                        ctx.fillText(text, -textWidth/2, -textHeight/2);
                        ctx.restore();
                    }
                }
            } else {
                // 单个位置水印
                const pos = calculatePosition(width, height, textWidth, textHeight, position, margin);
                
                ctx.save();
                ctx.translate(pos.x + textWidth/2, pos.y + textHeight/2);
                ctx.rotate(rotation * Math.PI / 180);
                ctx.fillText(text, -textWidth/2, -textHeight/2);
                ctx.restore();
            }
        }
        
        // 添加图片水印
        function addImageWatermark(ctx, width, height, position, rotation, margin) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const watermarkImg = new Image();
                    watermarkImg.onload = function() {
                        const maxWatermarkSize = Math.min(width, height) * 0.3;
                        const scale = Math.min(maxWatermarkSize / watermarkImg.width, maxWatermarkSize / watermarkImg.height);
                        const watermarkWidth = watermarkImg.width * scale;
                        const watermarkHeight = watermarkImg.height * scale;
                        
                        if (position === 'repeat') {
                            // 平铺水印
                            const spacing = Math.max(watermarkWidth, watermarkHeight) + 50;
                            for (let x = 0; x < width; x += spacing) {
                                for (let y = 0; y < height; y += spacing) {
                                    ctx.save();
                                    ctx.translate(x + watermarkWidth/2, y + watermarkHeight/2);
                                    ctx.rotate(rotation * Math.PI / 180);
                                    ctx.drawImage(watermarkImg, -watermarkWidth/2, -watermarkHeight/2, watermarkWidth, watermarkHeight);
                                    ctx.restore();
                                }
                            }
                        } else {
                            // 单个位置水印
                            const pos = calculatePosition(width, height, watermarkWidth, watermarkHeight, position, margin);
                            
                            ctx.save();
                            ctx.translate(pos.x + watermarkWidth/2, pos.y + watermarkHeight/2);
                            ctx.rotate(rotation * Math.PI / 180);
                            ctx.drawImage(watermarkImg, -watermarkWidth/2, -watermarkHeight/2, watermarkWidth, watermarkHeight);
                            ctx.restore();
                        }
                        resolve();
                    };
                    watermarkImg.src = e.target.result;
                };
                reader.readAsDataURL(watermarkImageFile);
            });
        }
        
        // 计算水印位置
        function calculatePosition(canvasWidth, canvasHeight, watermarkWidth, watermarkHeight, position, margin) {
            let x, y;
            
            switch (position) {
                case 'top-left':
                    x = margin;
                    y = margin;
                    break;
                case 'top-right':
                    x = canvasWidth - watermarkWidth - margin;
                    y = margin;
                    break;
                case 'bottom-left':
                    x = margin;
                    y = canvasHeight - watermarkHeight - margin;
                    break;
                case 'bottom-right':
                    x = canvasWidth - watermarkWidth - margin;
                    y = canvasHeight - watermarkHeight - margin;
                    break;
                case 'center':
                    x = (canvasWidth - watermarkWidth) / 2;
                    y = (canvasHeight - watermarkHeight) / 2;
                    break;
                default:
                    x = canvasWidth - watermarkWidth - margin;
                    y = canvasHeight - watermarkHeight - margin;
            }
            
            return { x, y };
        }
        
        // 计算尺寸
        function calculateDimensions(originalWidth, originalHeight, maxWidth, maxHeight) {
            let width = originalWidth;
            let height = originalHeight;
            
            if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
            }
            
            if (height > maxHeight) {
                width = (width * maxHeight) / height;
                height = maxHeight;
            }
            
            return { width: Math.round(width), height: Math.round(height) };
        }
        
        // 下载所有处理后的图片
        function downloadAll() {
            if (processedImages.length === 0) {
                showNotification('没有可下载的图片', 'error');
                return;
            }
            
            processedImages.forEach((imageData, index) => {
                setTimeout(() => {
                    const url = URL.createObjectURL(imageData.blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = imageData.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, index * 100);
            });
            
            showNotification(`开始下载 ${processedImages.length} 张图片`);
        }
        
        // 重置所有
        function resetAll() {
            uploadedFiles = [];
            watermarkImageFile = null;
            processedImages = [];
            
            document.getElementById('fileInput').value = '';
            document.getElementById('watermarkImage').value = '';
            document.getElementById('watermarkText').value = '© ITMagical';
            document.getElementById('previewArea').style.display = 'none';
            document.getElementById('downloadAllBtn').style.display = 'none';
            
            updateFileList();
            updateRangeValues();
            showNotification('已重置所有设置');
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 显示通知
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? '#dc3545' : '#28a745'};
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: 600;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // FAQ切换
        function toggleFaq(element) {
            const answer = element.nextElementSibling;
            const icon = element.querySelector('span:last-child');
            
            if (answer.classList.contains('active')) {
                answer.classList.remove('active');
                icon.textContent = '+';
            } else {
                // 关闭其他FAQ
                document.querySelectorAll('.faq-answer.active').forEach(item => {
                    item.classList.remove('active');
                    item.previousElementSibling.querySelector('span:last-child').textContent = '+';
                });
                
                answer.classList.add('active');
                icon.textContent = '-';
            }
        }
        
        // 加载导航栏和页脚组件
        function loadComponents() {
            // 加载导航栏
            fetch('../components/navbar.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('navbar-placeholder').innerHTML = html;
                })
                .catch(error => console.log('导航栏加载失败:', error));
            
            // 加载页脚
            fetch('../components/footer.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('footer-placeholder').innerHTML = html;
                })
                .catch(error => console.log('页脚加载失败:', error));
        }
    </script>
</body>
</html>
